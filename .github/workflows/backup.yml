name: Backup Database and Storage

on:
  workflow_dispatch:  # Allow manual triggers
  schedule:
    - cron: '0 2 * * *'  # Daily at 2:00 AM UTC

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # âœ… FIX: Define all environment variables at job level
    # This makes them available to ALL steps
    env:
      SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.VITE_SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_DB_URL: ${{ secrets.DATABASE_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_S3_REGION: ${{ secrets.AWS_S3_REGION }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      SUPABASE_BUCKETS_TO_BACKUP: ${{ secrets.SUPABASE_BUCKETS_TO_BACKUP }}
      DISPATCH_ID: ${{ github.event.inputs.dispatch_id || github.run_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # âœ… FIX: Disable submodule checkout to avoid the warning
        with:
          submodules: false

      - name: Debug environment variables
        # âœ… DEBUG: Check if secrets are available (without exposing values)
        run: |
          echo "Checking environment variables..."
          echo "SUPABASE_URL: ${SUPABASE_URL:+SET (hidden)}${SUPABASE_URL:-MISSING}"
          echo "SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:+SET (hidden)}${SUPABASE_SERVICE_ROLE_KEY:-MISSING}"
          echo "SUPABASE_DB_URL: ${SUPABASE_DB_URL:+SET (hidden)}${SUPABASE_DB_URL:-MISSING}"
          echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:+SET (hidden)}${AWS_ACCESS_KEY_ID:-MISSING}"
          echo "AWS_S3_BUCKET: ${AWS_S3_BUCKET:+SET (hidden)}${AWS_S3_BUCKET:-MISSING}"
          echo "DISPATCH_ID: $DISPATCH_ID"
          
          # Check if secrets are actually set
          if [ -z "$SUPABASE_URL" ]; then
            echo "âŒ ERROR: SUPABASE_URL secret is not set in GitHub Secrets"
            echo "Please go to: Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "And add SUPABASE_URL secret"
            exit 1
          fi
          
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "âŒ ERROR: SUPABASE_SERVICE_ROLE_KEY secret is not set in GitHub Secrets"
            echo "Please go to: Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "And add SUPABASE_SERVICE_ROLE_KEY secret"
            exit 1
          fi
          
          echo "âœ“ All required secrets are set"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check backup enable status
        # âœ… FIX: Environment variables are inherited from job-level env:
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          // âœ… FIX: Get from process.env (automatically available from job env:)
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          
          // âœ… DEBUG: Validate URL format (without exposing full value)
          console.log('Validating Supabase URL...');
          console.log('URL length:', supabaseUrl ? supabaseUrl.length : 0);
          console.log('URL starts with https://', supabaseUrl ? supabaseUrl.startsWith('https://') : false);
          console.log('URL preview:', supabaseUrl ? supabaseUrl.substring(0, 30) + '...' : 'MISSING');
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('âœ— Missing Supabase credentials');
            console.error('SUPABASE_URL:', supabaseUrl ? 'SET' : 'MISSING');
            console.error('SUPABASE_SERVICE_ROLE_KEY:', supabaseKey ? 'SET' : 'MISSING');
            process.exit(1);
          }
          
          // âœ… FIX: Validate URL format
          if (!supabaseUrl.startsWith('http://') && !supabaseUrl.startsWith('https://')) {
            console.error('âœ— Invalid SUPABASE_URL format');
            console.error('URL must start with http:// or https://');
            console.error('Current value starts with:', supabaseUrl.substring(0, 20));
            console.error('Expected format: https://xxxxx.supabase.co');
            console.error('');
            console.error('Please check your VITE_SUPABASE_URL secret in GitHub Settings');
            console.error('It should be your Supabase project URL, not the database connection string');
            process.exit(1);
          }
          
          // âœ… FIX: Remove trailing slash if present
          const cleanUrl = supabaseUrl.replace(/\/$/, '');
          
          console.log('âœ“ Supabase credentials found');
          console.log('âœ“ URL format validated');
          const supabase = createClient(cleanUrl, supabaseKey);
          
          supabase
            .from('system_settings_kv')
            .select('value')
            .eq('key', 'backup_enabled')
            .single()
            .then(({ data, error }) => {
              if (error && error.code !== 'PGRST116') {
                console.error('âœ— Error checking backup status:', error);
                process.exit(1);
              }
              
              const enabled = data?.value?.enabled ?? false;
              if (!enabled) {
                console.log('â„¹ Backup is disabled. Exiting.');
                process.exit(0);
              }
              
              console.log('âœ“ Backup is enabled. Proceeding...');
            })
            .catch((err) => {
              console.error('âœ— Failed to check backup status:', err);
              process.exit(1);
            });
          "

      - name: Update backup status (in progress)
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const dispatchId = process.env.DISPATCH_ID;
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('âœ— Missing Supabase credentials');
            process.exit(1);
          }
          
          // âœ… FIX: Validate URL format
          if (!supabaseUrl.startsWith('http://') && !supabaseUrl.startsWith('https://')) {
            console.error('âœ— Invalid SUPABASE_URL format');
            console.error('URL must start with http:// or https://');
            console.error('Current value preview:', supabaseUrl.substring(0, 50));
            console.error('Expected format: https://xxxxx.supabase.co');
            process.exit(1);
          }
          
          const cleanUrl = supabaseUrl.replace(/\/$/, '');
          
          if (!dispatchId) {
            console.error('âœ— Missing DISPATCH_ID');
            process.exit(1);
          }
          
          console.log('âœ“ Updating backup status to in_progress');
          const supabase = createClient(cleanUrl, supabaseKey);
          
          supabase
            .from('backup_history')
            .update({ status: 'in_progress' })
            .eq('dispatch_id', dispatchId)
            .then(({ error }) => {
              if (error) {
                console.error('âœ— Error updating backup status:', error);
                process.exit(1);
              }
              console.log('âœ“ Backup status updated to in_progress');
            })
            .catch((err) => {
              console.error('âœ— Failed to update backup status:', err);
              process.exit(1);
            });
          "

      - name: Export database
        continue-on-error: true  # âœ… Continue workflow even if pg_dump fails
        run: |
          mkdir -p backup/db
          
          # âœ… FIX: Verify connection string is set
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "âŒ ERROR: DATABASE_URL secret is not set"
            echo "Please set DATABASE_URL secret in GitHub Settings"
            echo "Format: postgresql://postgres:password@db.xxxxx.supabase.co:5432/postgres"
            exit 1
          fi
          
          echo "âœ“ Starting database export..."
          echo "Connection string format: ${SUPABASE_DB_URL%%@*}@***" # Show only user@host part
          
          # âœ… FIX: Try pg_dump, handle network errors gracefully
          pg_dump "$SUPABASE_DB_URL" \
            --no-owner \
            --no-privileges \
            --format=plain \
            --blobs \
            --verbose \
            --file=backup/db/backup.sql \
            2>&1 | tee /tmp/pg_dump_output.log || {
              PG_DUMP_ERROR=$(cat /tmp/pg_dump_output.log)
              
              # Check if it's a network/unreachable error (Supabase free plan issue)
              if echo "$PG_DUMP_ERROR" | grep -q "Network is unreachable\|Connection refused\|timeout\|unreachable"; then
                echo ""
                echo "âš ï¸ WARNING: Direct database connection failed (Network unreachable)"
                echo "This is common with Supabase Free Plan - external connections are blocked"
                echo ""
                echo "ðŸ”„ Attempting backup via Supabase Edge Function (bypasses IP restrictions)..."
                echo ""
                
                # âœ… FIX: Use Edge Function to export database via API
                node -e "
                const { createClient } = require('@supabase/supabase-js');
                const fs = require('fs');
                
                const supabaseUrl = process.env.SUPABASE_URL;
                const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
                const userId = process.env.DISPATCH_ID || 'system'; // Use dispatch ID as user identifier
                
                if (!supabaseUrl || !supabaseKey) {
                  console.error('âœ— Cannot use Edge Function export - missing credentials');
                  process.exit(1);
                }
                
                if (!supabaseUrl.startsWith('http://') && !supabaseUrl.startsWith('https://')) {
                  console.error('âœ— Invalid SUPABASE_URL format');
                  process.exit(1);
                }
                
                const cleanUrl = supabaseUrl.replace(/\/$/, '');
                const supabase = createClient(cleanUrl, supabaseKey);
                
                console.log('âœ“ Calling export-database Edge Function...');
                console.log('  Note: This uses Supabase API (no IP restrictions)');
                
                // Call the Edge Function using fetch (more reliable in GitHub Actions)
                const functionUrl = cleanUrl + '/functions/v1/export-database';
                const response = await fetch(functionUrl, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + supabaseKey,
                    'apikey': supabaseKey,
                  },
                  body: JSON.stringify({ user_id: userId })
                });
                
                if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error('Edge Function returned ' + response.status + ': ' + errorText);
                }
                
                const result = await response.json();
                
                if (result.error || !result.success) {
                  throw new Error(result.error?.message || result.message || 'Export failed');
                }
                
                // Decode base64 SQL
                const sql = Buffer.from(result.sql_base64, 'base64').toString('utf-8');
                
                // Write to file
                fs.writeFileSync('backup/db/backup.sql', sql);
                
                console.log('âœ“ Database exported via Edge Function');
                console.log('  - Tables exported:', result.tables_exported, '/', result.tables_total || '?');
                console.log('  - SQL size:', (result.sql_size / 1024).toFixed(2), 'KB');
                console.log('  - Message:', result.message || 'Export completed');
                console.log('âš ï¸ Note: This is a data-only export (INSERT statements)');
                console.log('âš ï¸ Schema (CREATE TABLE, functions, triggers) is NOT included');
                console.log('âš ï¸ For complete backup with schema, use pg_dump (requires Pro plan or IP whitelisting)');
                })
                .catch((err) => {
                  console.error('âœ— Failed to export via Edge Function:', err.message);
                  console.error('');
                  console.error('ðŸ“‹ Alternative solutions:');
                  console.error('1. Enable IP whitelisting in Supabase Dashboard');
                  console.error('2. Upgrade to Supabase Pro Plan');
                  console.error('3. Use Supabase Dashboard backup feature');
                  console.error('');
                  console.error('Creating backup note file...');
                  
                  // Create note file
                  const note = '-- âš ï¸ DATABASE BACKUP FAILED - Network Connection Issue\n' +
                    '-- \n' +
                    '-- Error: Network is unreachable\n' +
                    '-- Cause: Supabase Free Plan blocks external database connections\n' +
                    '-- \n' +
                    '-- Attempted solutions:\n' +
                    '-- 1. Direct pg_dump connection: FAILED (network blocked)\n' +
                    '-- 2. Edge Function export: FAILED (' + err.message + ')\n' +
                    '-- \n' +
                    '-- Solutions:\n' +
                    '-- 1. Enable IP whitelisting in Supabase Dashboard:\n' +
                    '--    Settings â†’ Database â†’ Network Restrictions â†’ Add IPs\n' +
                    '--    (May not be available on free plan)\n' +
                    '-- \n' +
                    '-- 2. Upgrade to Supabase Pro Plan ($25/month):\n' +
                    '--    Includes IP whitelisting and external connection support\n' +
                    '-- \n' +
                    '-- 3. Use Supabase Dashboard backup (if available):\n' +
                    '--    Dashboard â†’ Database â†’ Backups â†’ Create backup\n' +
                    '-- \n' +
                    '-- This backup file is empty because database export could not be completed.\n' +
                    '-- Other backups (auth users, storage files) may still be available.\n' +
                    '-- \n' +
                    '-- For production use, upgrade to Pro Plan for reliable backups.\n';
                  
                  fs.writeFileSync('backup/db/backup.sql', note);
                  console.error('âœ“ Created backup note file');
                  process.exit(0); // Don't fail the workflow
                });
                "
                
                if [ $? -eq 0 ] && [ -f backup/db/backup.sql ] && [ -s backup/db/backup.sql ]; then
                  echo "âœ“ Database backup completed via Edge Function"
                else
                  echo "âš ï¸ Database backup via Edge Function also failed"
                  echo "âš ï¸ Workflow will continue with other backups (auth users, storage)"
                fi
                # Don't exit with error - let workflow continue
                exit 0
              else
                echo "âŒ pg_dump failed with error:"
                echo "$PG_DUMP_ERROR"
                echo ""
                echo "Common issues:"
                echo "1. Connection string format incorrect"
                echo "2. Database password incorrect"
                echo "3. Using pooled connection (port 6543) instead of direct (port 5432)"
                echo "4. IP not whitelisted (Supabase free plan may require IP whitelisting)"
                echo ""
                echo "Verify DATABASE_URL format:"
                echo "Correct: postgresql://postgres:password@db.xxxxx.supabase.co:5432/postgres"
                echo "Wrong:   postgresql://postgres:password@aws-1-eu-west-1.pooler.supabase.com:6543/postgres"
                # Exit with error for other issues (not network)
                exit 1
              fi
            }
          
          if [ -f backup/db/backup.sql ] && [ -s backup/db/backup.sql ]; then
            echo "âœ“ Database export completed successfully"
          else
            echo "âš ï¸ Database export file is empty or missing"
          fi

      - name: Export auth users
        run: |
          mkdir -p backup/auth
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const fs = require('fs');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('âœ— Missing Supabase credentials');
            process.exit(1);
          }
          
          // âœ… FIX: Validate URL format
          if (!supabaseUrl.startsWith('http://') && !supabaseUrl.startsWith('https://')) {
            console.error('âœ— Invalid SUPABASE_URL format');
            console.error('URL must start with http:// or https://');
            console.error('Current value preview:', supabaseUrl.substring(0, 50));
            console.error('Expected format: https://xxxxx.supabase.co');
            process.exit(1);
          }
          
          const cleanUrl = supabaseUrl.replace(/\/$/, '');
          const supabase = createClient(cleanUrl, supabaseKey);
          
          supabase.auth.admin.listUsers()
            .then(({ data, error }) => {
              if (error) {
                console.error('âœ— Error listing users:', error);
                throw error;
              }
              fs.writeFileSync(
                'backup/auth/users.json',
                JSON.stringify(data.users, null, 2)
              );
              console.log('âœ“ Exported', data.users.length, 'auth users');
            })
            .catch((err) => {
              console.error('âœ— Failed to export auth users:', err);
              process.exit(1);
            });
          "

      - name: Download Supabase Storage files
        run: |
          mkdir -p backup/storage
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const fs = require('fs');
          const path = require('path');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const buckets = (process.env.SUPABASE_BUCKETS_TO_BACKUP || '')
            .split(',')
            .map(b => b.trim())
            .filter(Boolean);
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('âœ— Missing Supabase credentials');
            process.exit(1);
          }
          
          // âœ… FIX: Validate URL format
          if (!supabaseUrl.startsWith('http://') && !supabaseUrl.startsWith('https://')) {
            console.error('âœ— Invalid SUPABASE_URL format');
            console.error('URL must start with http:// or https://');
            console.error('Current value preview:', supabaseUrl.substring(0, 50));
            console.error('Expected format: https://xxxxx.supabase.co');
            process.exit(1);
          }
          
          const cleanUrl = supabaseUrl.replace(/\/$/, '');
          
          if (buckets.length === 0) {
            console.log('â„¹ No buckets to backup');
            process.exit(0);
          }
          
          console.log('âœ“ Backing up buckets:', buckets.join(', '));
          const supabase = createClient(cleanUrl, supabaseKey);
          
          async function downloadBucket(bucketName) {
            try {
              const { data: files, error } = await supabase.storage
                .from(bucketName)
                .list('', { limit: 1000, recursive: true });
              
              if (error) {
                console.error('âœ— Error listing files in', bucketName, ':', error.message);
                return;
              }
              
              if (!files || files.length === 0) {
                console.log('â„¹ No files in bucket:', bucketName);
                return;
              }
              
              const bucketDir = path.join('backup/storage', bucketName);
              fs.mkdirSync(bucketDir, { recursive: true });
              
              let downloaded = 0;
              for (const file of files) {
                if (file.id) {
                  try {
                    const { data, error: downloadError } = await supabase.storage
                      .from(bucketName)
                      .download(file.name);
                    
                    if (downloadError) {
                      console.error('âœ— Error downloading', file.name, ':', downloadError.message);
                      continue;
                    }
                    
                    const filePath = path.join(bucketDir, file.name);
                    const dir = path.dirname(filePath);
                    fs.mkdirSync(dir, { recursive: true });
                    fs.writeFileSync(filePath, Buffer.from(await data.arrayBuffer()));
                    downloaded++;
                  } catch (fileErr) {
                    console.error('âœ— Error processing', file.name, ':', fileErr.message);
                  }
                }
              }
              
              console.log('âœ“ Downloaded', downloaded, 'files from', bucketName);
            } catch (bucketErr) {
              console.error('âœ— Error backing up bucket', bucketName, ':', bucketErr.message);
            }
          }
          
          Promise.all(buckets.map(downloadBucket))
            .then(() => console.log('âœ“ All storage files downloaded'))
            .catch((err) => {
              console.error('âœ— Failed to download storage files:', err);
              process.exit(1);
            });
          "

      - name: Create backup archive
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d-%H-%M-UTC")
          BACKUP_NAME="backup-$TIMESTAMP.zip"
          zip -r "$BACKUP_NAME" backup/
          echo "BACKUP_FILE=$BACKUP_NAME" >> $GITHUB_ENV
          echo "BACKUP_SIZE=$(stat -f%z "$BACKUP_NAME" 2>/dev/null || stat -c%s "$BACKUP_NAME")" >> $GITHUB_ENV
          echo "âœ“ Created backup archive: $BACKUP_NAME"

      - name: Upload to S3
        run: |
          S3_PATH="backups/$(date -u +"%Y/%m/%d")/${{ env.BACKUP_FILE }}"
          aws s3 cp "${{ env.BACKUP_FILE }}" "s3://$AWS_S3_BUCKET/$S3_PATH" \
            --region "$AWS_S3_REGION"
          echo "S3_KEY=$S3_PATH" >> $GITHUB_ENV
          echo "âœ“ Uploaded to S3: $S3_PATH"

      - name: Update backup_history and system_settings
        # âœ… FIX: Pass variables via command line, not export
        # Variables from env: are already available, but we pass STATUS/ERROR_TEXT explicitly
        run: |
          # Check if database backup failed (network issue)
          if [ -f backup/db/backup.sql ] && grep -q "DATABASE BACKUP FAILED" backup/db/backup.sql; then
            FINAL_STATUS="partial"
            FINAL_ERROR_TEXT="Database backup failed: Network unreachable (Supabase Free Plan blocks external connections). Auth users and storage files backed up successfully. Enable IP whitelisting or upgrade to Pro plan for complete backup."
          else
            FINAL_STATUS="success"
            FINAL_ERROR_TEXT=""
          fi
          
          S3_KEY="${{ env.S3_KEY }}"
          BACKUP_SIZE="${{ env.BACKUP_SIZE }}"
          
          # âœ… FIX: Pass variables directly to Node.js process
          STATUS="$FINAL_STATUS" \
          ERROR_TEXT="$FINAL_ERROR_TEXT" \
          S3_KEY="$S3_KEY" \
          BACKUP_SIZE="$BACKUP_SIZE" \
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          // âœ… FIX: Get all variables from process.env
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const dispatchId = process.env.DISPATCH_ID;
          const status = process.env.STATUS;
          const errorText = process.env.ERROR_TEXT || null;
          const s3Key = process.env.S3_KEY;
          const sizeBytes = process.env.BACKUP_SIZE ? parseInt(process.env.BACKUP_SIZE, 10) : null;
          
          // âœ… FIX: Validate all required variables
          if (!supabaseUrl || !supabaseKey) {
            console.error('âœ— CRITICAL ERROR: Missing Supabase credentials');
            console.error('SUPABASE_URL:', supabaseUrl ? 'SET' : 'MISSING');
            console.error('SUPABASE_SERVICE_ROLE_KEY:', supabaseKey ? 'SET' : 'MISSING');
            process.exit(1);
          }
          
          // âœ… FIX: Validate URL format
          if (!supabaseUrl.startsWith('http://') && !supabaseUrl.startsWith('https://')) {
            console.error('âœ— CRITICAL ERROR: Invalid SUPABASE_URL format');
            console.error('URL must start with http:// or https://');
            console.error('Current value preview:', supabaseUrl.substring(0, 50));
            console.error('Expected format: https://xxxxx.supabase.co');
            console.error('');
            console.error('Please check your VITE_SUPABASE_URL secret in GitHub Settings');
            console.error('It should be your Supabase project URL, NOT the database connection string');
            console.error('Correct: https://rqssjgiunwyjeyutgkkp.supabase.co');
            console.error('Wrong:   postgresql://postgres:password@db.xxxxx.supabase.co:5432/postgres');
            process.exit(1);
          }
          
          const cleanUrl = supabaseUrl.replace(/\/$/, '');
          
          if (!dispatchId) {
            console.error('âœ— CRITICAL ERROR: Missing DISPATCH_ID');
            process.exit(1);
          }
          
          console.log('âœ“ Supabase credentials validated');
          console.log('âœ“ URL format validated');
          console.log('âœ“ Updating backup_history with:');
          console.log('  - dispatch_id:', dispatchId);
          console.log('  - status:', status);
          console.log('  - s3_key:', s3Key);
          console.log('  - size_bytes:', sizeBytes);
          
          const supabase = createClient(cleanUrl, supabaseKey);
          
          // Update backup_history
          supabase
            .from('backup_history')
            .update({
              status: status,
              s3_key: s3Key,
              size_bytes: sizeBytes,
              error_text: errorText,
            })
            .eq('dispatch_id', dispatchId)
            .then(({ data, error }) => {
              if (error) {
                console.error('âœ— CRITICAL ERROR updating backup history');
                console.error('Error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error details:', error.details);
                console.error('Error hint:', error.hint);
                process.exit(1);
              }
              
              console.log('âœ“ Backup history updated successfully');
              
              // Update system_settings_kv
              return supabase
                .from('system_settings_kv')
                .upsert({
                  key: 'last_backup_at',
                  value: new Date().toISOString(),
                }, {
                  onConflict: 'key',
                });
            })
            .then(({ error: settingsError }) => {
              if (settingsError) {
                console.error('âš  Warning: Failed to update last_backup_at:', settingsError.message);
                // Don't fail the step, just log the warning
              } else {
                console.log('âœ“ System settings updated');
              }
            })
            .catch((err) => {
              console.error('âœ— CRITICAL ERROR:', err);
              process.exit(1);
            });
          "

      - name: Handle backup failure
        if: failure()
        # âœ… FIX: Use the same secret names as job-level env (VITE_ prefixed)
        env:
          SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.VITE_SUPABASE_SERVICE_ROLE_KEY }}
          DISPATCH_ID: ${{ github.event.inputs.dispatch_id || github.run_id }}
        run: |
          FINAL_STATUS="failed"
          FINAL_ERROR_TEXT="Backup workflow failed. Check GitHub Actions logs for details."
          
          # Debug: Check if variables are available
          echo "Debug: Checking environment variables in failure handler..."
          echo "SUPABASE_URL: ${SUPABASE_URL:+SET (hidden)}${SUPABASE_URL:-MISSING}"
          echo "SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:+SET (hidden)}${SUPABASE_SERVICE_ROLE_KEY:-MISSING}"
          echo "DISPATCH_ID: $DISPATCH_ID"
          
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ] || [ -z "$DISPATCH_ID" ]; then
            echo "âŒ Cannot update backup status - missing required variables"
            echo "This is a critical error. Please check GitHub Secrets configuration."
            exit 1
          fi
          
          STATUS="$FINAL_STATUS" \
          ERROR_TEXT="$FINAL_ERROR_TEXT" \
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const dispatchId = process.env.DISPATCH_ID;
          const status = process.env.STATUS;
          const errorText = process.env.ERROR_TEXT;
          
          if (!supabaseUrl || !supabaseKey || !dispatchId) {
            console.error('âœ— Cannot update backup status - missing credentials');
            console.error('SUPABASE_URL:', supabaseUrl ? 'SET' : 'MISSING');
            console.error('SUPABASE_SERVICE_ROLE_KEY:', supabaseKey ? 'SET' : 'MISSING');
            console.error('DISPATCH_ID:', dispatchId ? 'SET' : 'MISSING');
            process.exit(1);
          }
          
          // âœ… FIX: Validate URL format
          if (!supabaseUrl.startsWith('http://') && !supabaseUrl.startsWith('https://')) {
            console.error('âœ— Invalid SUPABASE_URL format');
            console.error('URL must start with http:// or https://');
            console.error('Current value preview:', supabaseUrl.substring(0, 50));
            console.error('Expected format: https://xxxxx.supabase.co');
            process.exit(1);
          }
          
          // âœ… FIX: Remove trailing slash if present
          const cleanUrl = supabaseUrl.replace(/\/$/, '');
          
          console.log('âœ“ Updating backup status to failed');
          const supabase = createClient(cleanUrl, supabaseKey);
          
          supabase
            .from('backup_history')
            .update({
              status: status,
              error_text: errorText,
            })
            .eq('dispatch_id', dispatchId)
            .then(({ error }) => {
              if (error) {
                console.error('âœ— Failed to update backup status to failed:', error.message);
                process.exit(1);
              } else {
                console.log('âœ“ Backup status updated to failed');
              }
            })
            .catch((err) => {
              console.error('âœ— Error updating backup status:', err);
              process.exit(1);
            });
          "
