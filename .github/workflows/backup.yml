name: Backup Database and Storage

on:
  workflow_dispatch:  # Allow manual triggers
  schedule:
    - cron: '0 2 * * *'  # Daily at 2:00 AM UTC

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # ✅ FIX: Define all environment variables at job level
    # This makes them available to ALL steps
    env:
      SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.VITE_SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_S3_REGION: ${{ secrets.AWS_S3_REGION }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      SUPABASE_BUCKETS_TO_BACKUP: ${{ secrets.SUPABASE_BUCKETS_TO_BACKUP }}
      DISPATCH_ID: ${{ github.event.inputs.dispatch_id || github.run_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # ✅ FIX: Disable submodule checkout to avoid the warning
        with:
          submodules: false

      - name: Debug environment variables
        # ✅ DEBUG: Check if secrets are available (without exposing values)
        run: |
          echo "Checking environment variables..."
          echo "SUPABASE_URL: ${SUPABASE_URL:+SET (hidden)}${SUPABASE_URL:-MISSING}"
          echo "SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:+SET (hidden)}${SUPABASE_SERVICE_ROLE_KEY:-MISSING}"
          echo "SUPABASE_DB_URL: ${SUPABASE_DB_URL:+SET (hidden)}${SUPABASE_DB_URL:-MISSING}"
          echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:+SET (hidden)}${AWS_ACCESS_KEY_ID:-MISSING}"
          echo "AWS_S3_BUCKET: ${AWS_S3_BUCKET:+SET (hidden)}${AWS_S3_BUCKET:-MISSING}"
          echo "DISPATCH_ID: $DISPATCH_ID"
          
          # Check if secrets are actually set
          if [ -z "$SUPABASE_URL" ]; then
            echo "❌ ERROR: SUPABASE_URL secret is not set in GitHub Secrets"
            echo "Please go to: Repository → Settings → Secrets and variables → Actions"
            echo "And add SUPABASE_URL secret"
            exit 1
          fi
          
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "❌ ERROR: SUPABASE_SERVICE_ROLE_KEY secret is not set in GitHub Secrets"
            echo "Please go to: Repository → Settings → Secrets and variables → Actions"
            echo "And add SUPABASE_SERVICE_ROLE_KEY secret"
            exit 1
          fi
          
          echo "✓ All required secrets are set"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check backup enable status
        # ✅ FIX: Environment variables are inherited from job-level env:
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          // ✅ FIX: Get from process.env (automatically available from job env:)
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('✗ Missing Supabase credentials');
            console.error('SUPABASE_URL:', supabaseUrl ? 'SET' : 'MISSING');
            console.error('SUPABASE_SERVICE_ROLE_KEY:', supabaseKey ? 'SET' : 'MISSING');
            process.exit(1);
          }
          
          console.log('✓ Supabase credentials found');
          const supabase = createClient(supabaseUrl, supabaseKey);
          
          supabase
            .from('system_settings_kv')
            .select('value')
            .eq('key', 'backup_enabled')
            .single()
            .then(({ data, error }) => {
              if (error && error.code !== 'PGRST116') {
                console.error('✗ Error checking backup status:', error);
                process.exit(1);
              }
              
              const enabled = data?.value?.enabled ?? false;
              if (!enabled) {
                console.log('ℹ Backup is disabled. Exiting.');
                process.exit(0);
              }
              
              console.log('✓ Backup is enabled. Proceeding...');
            })
            .catch((err) => {
              console.error('✗ Failed to check backup status:', err);
              process.exit(1);
            });
          "

      - name: Update backup status (in progress)
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const dispatchId = process.env.DISPATCH_ID;
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('✗ Missing Supabase credentials');
            process.exit(1);
          }
          
          if (!dispatchId) {
            console.error('✗ Missing DISPATCH_ID');
            process.exit(1);
          }
          
          console.log('✓ Updating backup status to in_progress');
          const supabase = createClient(supabaseUrl, supabaseKey);
          
          supabase
            .from('backup_history')
            .update({ status: 'in_progress' })
            .eq('dispatch_id', dispatchId)
            .then(({ error }) => {
              if (error) {
                console.error('✗ Error updating backup status:', error);
                process.exit(1);
              }
              console.log('✓ Backup status updated to in_progress');
            })
            .catch((err) => {
              console.error('✗ Failed to update backup status:', err);
              process.exit(1);
            });
          "

      - name: Export database
        run: |
          mkdir -p backup/db
          pg_dump --dbname="$SUPABASE_DB_URL" \
            --no-owner \
            --no-privileges \
            --format=plain \
            --blobs \
            --verbose \
            --file=backup/db/backup.sql

      - name: Export auth users
        run: |
          mkdir -p backup/auth
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const fs = require('fs');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('✗ Missing Supabase credentials');
            process.exit(1);
          }
          
          const supabase = createClient(supabaseUrl, supabaseKey);
          
          supabase.auth.admin.listUsers()
            .then(({ data, error }) => {
              if (error) {
                console.error('✗ Error listing users:', error);
                throw error;
              }
              fs.writeFileSync(
                'backup/auth/users.json',
                JSON.stringify(data.users, null, 2)
              );
              console.log('✓ Exported', data.users.length, 'auth users');
            })
            .catch((err) => {
              console.error('✗ Failed to export auth users:', err);
              process.exit(1);
            });
          "

      - name: Download Supabase Storage files
        run: |
          mkdir -p backup/storage
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const fs = require('fs');
          const path = require('path');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const buckets = (process.env.SUPABASE_BUCKETS_TO_BACKUP || '')
            .split(',')
            .map(b => b.trim())
            .filter(Boolean);
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('✗ Missing Supabase credentials');
            process.exit(1);
          }
          
          if (buckets.length === 0) {
            console.log('ℹ No buckets to backup');
            process.exit(0);
          }
          
          console.log('✓ Backing up buckets:', buckets.join(', '));
          const supabase = createClient(supabaseUrl, supabaseKey);
          
          async function downloadBucket(bucketName) {
            try {
              const { data: files, error } = await supabase.storage
                .from(bucketName)
                .list('', { limit: 1000, recursive: true });
              
              if (error) {
                console.error('✗ Error listing files in', bucketName, ':', error.message);
                return;
              }
              
              if (!files || files.length === 0) {
                console.log('ℹ No files in bucket:', bucketName);
                return;
              }
              
              const bucketDir = path.join('backup/storage', bucketName);
              fs.mkdirSync(bucketDir, { recursive: true });
              
              let downloaded = 0;
              for (const file of files) {
                if (file.id) {
                  try {
                    const { data, error: downloadError } = await supabase.storage
                      .from(bucketName)
                      .download(file.name);
                    
                    if (downloadError) {
                      console.error('✗ Error downloading', file.name, ':', downloadError.message);
                      continue;
                    }
                    
                    const filePath = path.join(bucketDir, file.name);
                    const dir = path.dirname(filePath);
                    fs.mkdirSync(dir, { recursive: true });
                    fs.writeFileSync(filePath, Buffer.from(await data.arrayBuffer()));
                    downloaded++;
                  } catch (fileErr) {
                    console.error('✗ Error processing', file.name, ':', fileErr.message);
                  }
                }
              }
              
              console.log('✓ Downloaded', downloaded, 'files from', bucketName);
            } catch (bucketErr) {
              console.error('✗ Error backing up bucket', bucketName, ':', bucketErr.message);
            }
          }
          
          Promise.all(buckets.map(downloadBucket))
            .then(() => console.log('✓ All storage files downloaded'))
            .catch((err) => {
              console.error('✗ Failed to download storage files:', err);
              process.exit(1);
            });
          "

      - name: Create backup archive
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d-%H-%M-UTC")
          BACKUP_NAME="backup-$TIMESTAMP.zip"
          zip -r "$BACKUP_NAME" backup/
          echo "BACKUP_FILE=$BACKUP_NAME" >> $GITHUB_ENV
          echo "BACKUP_SIZE=$(stat -f%z "$BACKUP_NAME" 2>/dev/null || stat -c%s "$BACKUP_NAME")" >> $GITHUB_ENV
          echo "✓ Created backup archive: $BACKUP_NAME"

      - name: Upload to S3
        run: |
          S3_PATH="backups/$(date -u +"%Y/%m/%d")/${{ env.BACKUP_FILE }}"
          aws s3 cp "${{ env.BACKUP_FILE }}" "s3://$AWS_S3_BUCKET/$S3_PATH" \
            --region "$AWS_S3_REGION"
          echo "S3_KEY=$S3_PATH" >> $GITHUB_ENV
          echo "✓ Uploaded to S3: $S3_PATH"

      - name: Update backup_history and system_settings
        # ✅ FIX: Pass variables via command line, not export
        # Variables from env: are already available, but we pass STATUS/ERROR_TEXT explicitly
        run: |
          FINAL_STATUS="success"
          FINAL_ERROR_TEXT=""
          S3_KEY="${{ env.S3_KEY }}"
          BACKUP_SIZE="${{ env.BACKUP_SIZE }}"
          
          # ✅ FIX: Pass variables directly to Node.js process
          STATUS="$FINAL_STATUS" \
          ERROR_TEXT="$FINAL_ERROR_TEXT" \
          S3_KEY="$S3_KEY" \
          BACKUP_SIZE="$BACKUP_SIZE" \
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          // ✅ FIX: Get all variables from process.env
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const dispatchId = process.env.DISPATCH_ID;
          const status = process.env.STATUS;
          const errorText = process.env.ERROR_TEXT || null;
          const s3Key = process.env.S3_KEY;
          const sizeBytes = process.env.BACKUP_SIZE ? parseInt(process.env.BACKUP_SIZE, 10) : null;
          
          // ✅ FIX: Validate all required variables
          if (!supabaseUrl || !supabaseKey) {
            console.error('✗ CRITICAL ERROR: Missing Supabase credentials');
            console.error('SUPABASE_URL:', supabaseUrl ? 'SET' : 'MISSING');
            console.error('SUPABASE_SERVICE_ROLE_KEY:', supabaseKey ? 'SET' : 'MISSING');
            process.exit(1);
          }
          
          if (!dispatchId) {
            console.error('✗ CRITICAL ERROR: Missing DISPATCH_ID');
            process.exit(1);
          }
          
          console.log('✓ Supabase credentials validated');
          console.log('✓ Updating backup_history with:');
          console.log('  - dispatch_id:', dispatchId);
          console.log('  - status:', status);
          console.log('  - s3_key:', s3Key);
          console.log('  - size_bytes:', sizeBytes);
          
          const supabase = createClient(supabaseUrl, supabaseKey);
          
          // Update backup_history
          supabase
            .from('backup_history')
            .update({
              status: status,
              s3_key: s3Key,
              size_bytes: sizeBytes,
              error_text: errorText,
            })
            .eq('dispatch_id', dispatchId)
            .then(({ data, error }) => {
              if (error) {
                console.error('✗ CRITICAL ERROR updating backup history');
                console.error('Error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error details:', error.details);
                console.error('Error hint:', error.hint);
                process.exit(1);
              }
              
              console.log('✓ Backup history updated successfully');
              
              // Update system_settings_kv
              return supabase
                .from('system_settings_kv')
                .upsert({
                  key: 'last_backup_at',
                  value: new Date().toISOString(),
                }, {
                  onConflict: 'key',
                });
            })
            .then(({ error: settingsError }) => {
              if (settingsError) {
                console.error('⚠ Warning: Failed to update last_backup_at:', settingsError.message);
                // Don't fail the step, just log the warning
              } else {
                console.log('✓ System settings updated');
              }
            })
            .catch((err) => {
              console.error('✗ CRITICAL ERROR:', err);
              process.exit(1);
            });
          "

      - name: Handle backup failure
        if: failure()
        # ✅ FIX: Ensure env variables are available in failure handler
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DISPATCH_ID: ${{ github.event.inputs.dispatch_id || github.run_id }}
        run: |
          FINAL_STATUS="failed"
          FINAL_ERROR_TEXT="Backup workflow failed. Check GitHub Actions logs for details."
          
          # Debug: Check if variables are available
          echo "Debug: Checking environment variables in failure handler..."
          echo "SUPABASE_URL: ${SUPABASE_URL:+SET (hidden)}${SUPABASE_URL:-MISSING}"
          echo "SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:+SET (hidden)}${SUPABASE_SERVICE_ROLE_KEY:-MISSING}"
          echo "DISPATCH_ID: $DISPATCH_ID"
          
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ] || [ -z "$DISPATCH_ID" ]; then
            echo "❌ Cannot update backup status - missing required variables"
            echo "This is a critical error. Please check GitHub Secrets configuration."
            exit 1
          fi
          
          STATUS="$FINAL_STATUS" \
          ERROR_TEXT="$FINAL_ERROR_TEXT" \
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const dispatchId = process.env.DISPATCH_ID;
          const status = process.env.STATUS;
          const errorText = process.env.ERROR_TEXT;
          
          if (!supabaseUrl || !supabaseKey || !dispatchId) {
            console.error('✗ Cannot update backup status - missing credentials');
            console.error('SUPABASE_URL:', supabaseUrl ? 'SET' : 'MISSING');
            console.error('SUPABASE_SERVICE_ROLE_KEY:', supabaseKey ? 'SET' : 'MISSING');
            console.error('DISPATCH_ID:', dispatchId ? 'SET' : 'MISSING');
            process.exit(1);
          }
          
          console.log('✓ Updating backup status to failed');
          const supabase = createClient(supabaseUrl, supabaseKey);
          
          supabase
            .from('backup_history')
            .update({
              status: status,
              error_text: errorText,
            })
            .eq('dispatch_id', dispatchId)
            .then(({ error }) => {
              if (error) {
                console.error('✗ Failed to update backup status to failed:', error.message);
                process.exit(1);
              } else {
                console.log('✓ Backup status updated to failed');
              }
            })
            .catch((err) => {
              console.error('✗ Error updating backup status:', err);
              process.exit(1);
            });
          "
